<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MultiScan POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --verde:#39d353;
  --blanco:#ffffff;
  --rojo:#ff4d4d;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:#000;
  color:#fff;
}

/* ---------- TOP BAR ---------- */
.topbar{
  position:sticky;
  top:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:rgba(0,0,0,.75);
  backdrop-filter: blur(6px);
  border-bottom:1px solid #222;
}

.logo-box{
  background:#fff;
  padding:6px 10px;
  border-radius:10px;
  display:flex;
  align-items:center;
}

.logo-box img{ height:26px; }

.btn-back{
  background:#111;
  color:#fff;
  border:1px solid #333;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
}

/* ---------- WRAPPER ---------- */
.wrap{
  max-width:720px;
  margin:0 auto;
  padding:14px 12px 40px;
}

h2{
  margin:12px 0 6px;
  letter-spacing:.8px;
  text-transform:uppercase;
}

.meta{
  font-size:14px;
  opacity:.9;
}

.stats{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.card{
  flex:1;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.09);
  padding:10px 12px;
  border-radius:14px;
  min-width:140px;
  text-align:center;
}

.card b{ color:var(--verde); }

#scanInput{
  width:100%;
  margin:10px 0;
  font-size:22px;
  padding:14px;
  border-radius:12px;
  border:1px solid #333;
  background:#0b0b0b;
  color:#fff;
}

#status{
  margin:6px 0 0;
  font-size:14px;
  min-height:18px;
}

#status.ok{ color:var(--verde); }
#status.err{ color:var(--rojo); }

table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
  background:rgba(0,0,0,.6);
  border-radius:12px;
  overflow:hidden;
  font-size:14px;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid #2a2a2a;
}

th{
  text-align:left;
  background:#111;
  font-weight:600;
}

tr:last-child td{ border-bottom:none; }
</style>
</head>

<body>

<div class="topbar">
  <div class="logo-box">
    <img src="https://revstudio.design/wp-content/uploads/2023/10/RevStudio-logo.png" alt="RevStudio">
  </div>
  <button id="btnVolver" class="btn-back" onclick="volver()">⬅ Volver</button>
</div>

<div class="wrap">
  <h2 id="titulo">MULTISCAN</h2>

  <div class="meta">
    Cliente: <b id="cliente">—</b> · Orden ID: <b id="orden">—</b>
  </div>

  <div class="stats">
    <div class="card">
      Sesión<br><b id="cntSesion">0</b>
    </div>
    <div class="card">
      <span id="lblTotal">Total</span><br><b id="cntTotal">0</b>
    </div>
  </div>

  <input
    id="scanInput"
    type="text"
    autocomplete="off"
    autocorrect="off"
    spellcheck="false"
    placeholder="Escanee código…"
  >

  <p id="status"></p>

  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Cant.</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script>
/* ================= CONFIG ================= */
const APPSHEET_APP_ID = "134208bd-92de-4550-b09a-657cb1cbdf2e";
const APPSHEET_KEY   = "V2-1yk0i-hFZLD-4XZ3z-n5RCB-Cl6iS-MocBD-nFdJb-Cta9q";

// Nombres por defecto de las tablas (ajusta si en tu AppSheet tienen otra escritura)
const TABLE_FACTURAS  = "SALIDAS FACTURAS";
const TABLE_PRESTAMOS = "SALIDAS PRESTAMOS";
/* ========================================= */

/* ---------- PARAMS ---------- */
const params = new URLSearchParams(location.search);
const ORDEN_ID = Number(params.get("orden_id"));
const CLIENTE  = params.get("cliente") || "—";
const TOTAL_INICIAL = Number(params.get("total") || 0);

// tipo= factura | prestamo  (también acepta modo=...)
function stripAccents(s){
  try{ return (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
  catch(_){ return (s || ""); }
}
const rawTipo = (params.get("tipo") || params.get("modo") || "factura").toLowerCase();
const tipo = stripAccents(rawTipo).replace(/\s+/g,"");
const ES_PRESTAMO = (tipo === "prestamo" || tipo === "prestamos" || tipo.startsWith("prest"));

const TABLA_ACTIVA = ES_PRESTAMO ? TABLE_PRESTAMOS : TABLE_FACTURAS;
const BACK_VIEW    = ES_PRESTAMO ? "PRESTAMOS_Detail" : "FACTURAS_Detail";
const BACK_TEXT    = ES_PRESTAMO ? "⬅ Volver a préstamo" : "⬅ Volver a factura";
const TITULO       = ES_PRESTAMO ? "MULTISCAN PRESTAMO" : "MULTISCAN FACTURA";
const TOTAL_LABEL  = ES_PRESTAMO ? "Total prestamos" : "Total factura";

document.getElementById("orden").textContent   = ORDEN_ID;
document.getElementById("cliente").textContent = CLIENTE;

// UI dinámica (título / botón / contador)
document.title = TITULO;
document.getElementById("titulo").textContent = TITULO;
document.getElementById("btnVolver").textContent = BACK_TEXT;
document.getElementById("lblTotal").textContent  = TOTAL_LABEL;

/* ---------- ELEMENTS ---------- */
const input  = document.getElementById("scanInput");
const status = document.getElementById("status");
const lista  = document.getElementById("lista");
const cntS   = document.getElementById("cntSesion");
const cntT   = document.getElementById("cntTotal");

/* ---------- CONTADORES ---------- */
let sesion = 0;
let totalSalida = TOTAL_INICIAL;
cntT.textContent = totalSalida;

/* ---------- FOCO AUTOMÁTICO ---------- */
window.addEventListener("load", () => {
  setTimeout(() => input.focus(), 300);
});

/* ---------- SESIÓN (separada por tipo + orden, para que NO choque) ---------- */
const SESSION_KEY = "multiscan_cnt_" + (ES_PRESTAMO ? "prestamo_" : "factura_") + ORDEN_ID;
sesion = Number(sessionStorage.getItem(SESSION_KEY) || 0);
cntS.textContent = sesion;

/* ---------- API ---------- */
async function api(url, body){
  const r = await fetch(url,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "ApplicationAccessKey":APPSHEET_KEY
    },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw await r.text();
}

/* ---------- BEEP ---------- */
function beep(){
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.frequency.value = 800;
  o.connect(ctx.destination);
  o.start();
  setTimeout(()=>o.stop(),100);
}

/* ---------- ESCANEO ---------- */
input.addEventListener("keydown", async (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();

    const codigo = input.value.trim().replace(/\s+/g,"");
    input.value = "";
    if(!codigo) return;

    status.textContent = "Enviando…";
    status.className = "";

    try{
      const url = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${encodeURIComponent(TABLA_ACTIVA)}/Action`;
      const body = {
        Action:"ADD",
        Properties:{ Locale:"es-ES" },
        Rows:[{
          ID: crypto.randomUUID(),
          "ORDEN ID": ORDEN_ID,
          "CODIGO_ESCANEO": codigo,
          "CANTIDAD": 1
        }]
      };
      await api(url, body);

      beep();

      sesion++;
      sessionStorage.setItem(SESSION_KEY, sesion);
      cntS.textContent = sesion;

      totalSalida++;
      cntT.textContent = totalSalida;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${codigo}</td><td>1</td>`;
      lista.prepend(tr);

      status.textContent = "OK";
      status.className = "ok";

      setTimeout(() => input.focus(), 50);

    }catch(err){
      console.error(err);
      status.textContent = "ERROR – no se pudo registrar";
      status.className = "err";
      setTimeout(() => input.focus(), 50);
    }
  }
});

function volver(){
  const urlApp = `appsheet://www.appsheet.com/start/${APPSHEET_APP_ID}#view=${BACK_VIEW}&row=${encodeURIComponent(ORDEN_ID)}`;
  const urlWeb = `https://www.appsheet.com/start/${APPSHEET_APP_ID}#view=${BACK_VIEW}&row=${encodeURIComponent(ORDEN_ID)}`;

  // Intenta abrir AppSheet
  window.location.href = urlApp;

  // Fallback por si Android no intercepta el scheme
  setTimeout(() => {
    window.location.href = urlWeb;
  }, 600);
}
</script>

</body>
</html>
