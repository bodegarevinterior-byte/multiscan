<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MultiScan POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --verde:#39d353;
  --blanco:#ffffff;
  --rojo:#ff4d4d;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  color:var(--blanco);
  background:
    linear-gradient(rgba(0,0,0,.65), rgba(0,0,0,.65)),
    url("https://w0.peakpx.com/wallpaper/551/953/HD-wallpaper-solar-system-space-planets-universe-sparkles-star-galaxy.jpg")
    center/cover no-repeat fixed;
}

/* ---------- TOP BAR ---------- */
.topbar{
  position:sticky;
  top:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:rgba(0,0,0,.75);
}

.logo-box{
  background:#fff;
  padding:6px 10px;
  border-radius:10px;
  display:flex;
  align-items:center;
}

.logo-box img{ height:26px; }

.btn-back{
  background:#111;
  color:#fff;
  border:1px solid #333;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
}

/* ---------- CONTENT ---------- */
.wrap{ padding:14px; }

h2{
  margin:8px 0 4px;
  text-align:center;
  color:var(--verde);
}

.meta{
  text-align:center;
  font-size:14px;
  margin-bottom:8px;
}

.stats{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}

.card{
  background:rgba(0,0,0,.6);
  border:1px solid #333;
  border-radius:10px;
  padding:8px 12px;
  min-width:140px;
  text-align:center;
}

.card b{ color:var(--verde); }

#scanInput{
  width:100%;
  margin:10px 0;
  font-size:22px;
  padding:14px;
  border-radius:12px;
  border:1px solid #333;
  background:#0b0b0b;
  color:#fff;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
  background:rgba(0,0,0,.6);
  border-radius:12px;
  overflow:hidden;
  font-size:14px;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid #2a2a2a;
}

th{ color:#ddd; text-align:left; }

.ok{ color:var(--verde); text-align:center; }
.err{ color:var(--rojo); text-align:center; }
</style>
</head>

<body>

<div class="topbar">
  <div class="logo-box">
    <img src="https://revstudio.design/wp-content/uploads/2023/10/RevStudio-logo.png" alt="RevStudio">
  </div>
  <button class="btn-back" onclick="volver()">⬅ Volver a factura</button>
</div>

<div class="wrap">
  <h2>MULTISCAN</h2>

  <div class="meta">
    Cliente: <b id="cliente">—</b> · Orden ID: <b id="orden">—</b>
  </div>

  <div class="stats">
    <div class="card">
      Sesión<br><b id="cntSesion">0</b>
    </div>
    <div class="card">
      Total factura<br><b id="cntTotal">0</b>
    </div>
  </div>

  <input
    id="scanInput"
    type="text"
    autocomplete="off"
    autocorrect="off"
    spellcheck="false"
    placeholder="Escanee código…"
  >

  <p id="status"></p>

  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Cant.</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script>
/* ================= CONFIG ================= */
const APPSHEET_APP_ID = "134208bd-92de-4550-b09a-657cb1cbdf2e";
const APPSHEET_KEY   = "V2-1yk0i-hFZLD-4XZ3z-n5RCB-Cl6iS-MocBD-nFdJb-Cta9q";
const TABLE_LINES    = "SALIDAS FACTURAS";
/* ========================================= */

/* ---------- PARAMS ---------- */
const params = new URLSearchParams(location.search);
const ORDEN_ID = Number(params.get("orden_id"));
const CLIENTE  = params.get("cliente") || "—";
const TOTAL_INICIAL = Number(params.get("total") || 0);

document.getElementById("orden").textContent   = ORDEN_ID;
document.getElementById("cliente").textContent = CLIENTE;

/* ---------- ELEMENTS ---------- */
const input  = document.getElementById("scanInput");
const status = document.getElementById("status");
const lista  = document.getElementById("lista");
const cntS   = document.getElementById("cntSesion");
const cntT   = document.getElementById("cntTotal");

/* ---------- CONTADORES ---------- */
let sesion = 0;
let totalFactura = TOTAL_INICIAL;
cntT.textContent = totalFactura;

/* ---------- FOCO AUTOMÁTICO ---------- */
window.addEventListener("load", () => {
  setTimeout(() => input.focus(), 300);
});

/* ---------- SESIÓN ---------- */
const SESSION_KEY = "multiscan_cnt_" + ORDEN_ID;
sesion = Number(sessionStorage.getItem(SESSION_KEY) || 0);
cntS.textContent = sesion;

/* ---------- API ---------- */
async function api(url, body){
  const r = await fetch(url,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "ApplicationAccessKey":APPSHEET_KEY
    },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw await r.text();
}

/* ---------- BEEP ---------- */
function beep(){
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.frequency.value = 800;
  o.connect(ctx.destination);
  o.start();
  setTimeout(()=>o.stop(),100);
}

/* ---------- ESCANEO ---------- */
input.addEventListener("keydown", async (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();

    const codigo = input.value.trim().replace(/\s+/g,"");
    input.value = "";
    if(!codigo) return;

    status.textContent = "Enviando…";
    status.className = "";

    try{
      const url = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${encodeURIComponent(TABLE_LINES)}/Action`;
      const body = {
        Action:"UNIFICAR_SCAN",
        Properties:{ Locale:"es-ES" },
        Rows:[{
          ID: crypto.randomUUID(),
          "ORDEN ID": ORDEN_ID,
          "CODIGO_ESCANEO": codigo,
          "CANTIDAD": 1
        }]
      };
      await api(url, body);

      beep();

      sesion++;
      sessionStorage.setItem(SESSION_KEY, sesion);
      cntS.textContent = sesion;

      totalFactura++;
      cntT.textContent = totalFactura;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${codigo}</td><td>1</td>`;
      lista.prepend(tr);

      status.textContent = "OK";
      status.className = "ok";

      setTimeout(() => input.focus(), 50);

    }catch(err){
      console.error(err);
      status.textContent = "ERROR – no se pudo registrar";
      status.className = "err";
      setTimeout(() => input.focus(), 50);
    }
  }
});

/* ---------- VOLVER ---------- */
function volver(){
  window.location.href = "appsheet://";
}
</script>

</body>
</html>

