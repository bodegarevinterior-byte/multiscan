<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MultiScan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0f0;
      text-align: center;
      padding: 20px;
    }
    input {
      font-size: 22px;
      padding: 10px;
      width: 90%;
    }
    .ok { color: #0f0; }
    .err { color: #f00; }
  </style>
</head>
<body>

  <h2>MULTISCAN</h2>
  <p>Orden ID: <span id="orden"></span></p>

  <input
    id="scanInput"
    type="text"
    autofocus
    placeholder="Escanee cÃ³digo..."
  />

  <p id="status"></p>

<script>
/* ================= CONFIG ================= */
const APPSHEET_APP_ID = "134208bd-92de-4550-b09a-657cb1cbdf2e";
const APPSHEET_KEY    = "V2-1yk0i-hFZLD-4XZ3z-n5RCB-Cl6iS-MocBD-nFdJb-Cta9q";
const TABLE_NAME      = "SALIDAS FACTURAS";
/* ========================================= */

const params = new URLSearchParams(window.location.search);
const ORDEN_ID = params.get("orden_id");

document.getElementById("orden").textContent = ORDEN_ID;

const input = document.getElementById("scanInput");
const status = document.getElementById("status");

input.addEventListener("keydown", async (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    const codigo = input.value.trim();
    if (!codigo) return;

    input.value = "";
    status.textContent = "Enviando...";
    status.className = "";

    try {
      await enviarASAppSheet(codigo);
      status.textContent = "OK";
      status.className = "ok";
    } catch (err) {
      status.textContent = "ERROR";
      status.className = "err";
      console.error(err);
    }
  }
});

async function enviarASAppSheet(codigo) {
  const url = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${encodeURIComponent(TABLE_NAME)}/Action`;

  const body = {
    Action: "Add",
    Properties: {
      Locale: "es-ES"
    },
    Rows: [
      {
        "ID": crypto.randomUUID(),
        "ORDEN ID": ORDEN_ID,
        "CODIGO_ESCANEO": codigo,
        "CANTIDAD": 1
      }
    ]
  };

  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "ApplicationAccessKey": APPSHEET_KEY
    },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error(txt);
  }
}
</script>

</body>
</html>
