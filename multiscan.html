<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MultiScan POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --verde:#39d353;
  --blanco:#ffffff;
  --rojo:#ff4d4d;
  --amarillo:#ffb020; /* ✅ NUEVO: aviso código inválido */
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  color:var(--blanco);
  background:
    linear-gradient(rgba(0,0,0,.65), rgba(0,0,0,.65)),
    url("https://w0.peakpx.com/wallpaper/551/953/HD-wallpaper-solar-system-space-planets-universe-sparkles-star-galaxy.jpg")
    center/cover no-repeat fixed;
}

/* ---------- TOP BAR ---------- */
.topbar{
  position:sticky;
  top:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:rgba(0,0,0,.75);
}

.logo-box{
  background:#fff;
  padding:6px 10px;
  border-radius:10px;
  display:flex;
  align-items:center;
}

.logo-box img{ height:26px; }

.btn-back{
  background:#111;
  color:#fff;
  border:1px solid #333;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
}

/* ---------- WRAPPER ---------- */
.wrap{
  max-width:720px;
  margin:0 auto;
  padding:14px 12px 40px;
  text-align:center;
}

h2{
  margin:12px 0 6px;
  letter-spacing:.8px;
  text-transform:uppercase;
}

.meta{
  font-size:14px;
  opacity:.95;
}

.stats{
  display:flex;
  gap:10px;
  margin-top:10px;
  justify-content:center;
}

.card{
  flex:1;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  border-radius:14px;
  min-width:140px;
  text-align:center;
}

.card b{ color:var(--verde); }

#scanInput{
  width:100%;
  margin:10px 0;
  font-size:22px;
  padding:14px;
  border-radius:12px;
  border:1px solid #333;
  background:rgba(0,0,0,.45);
  color:#fff;
  text-align:center;
}

#status{
  margin:6px 0 0;
  font-size:14px;
  min-height:18px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
  background:rgba(0,0,0,.55);
  border-radius:12px;
  overflow:hidden;
  font-size:14px;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid #2a2a2a;
}

th{ color:#ddd; text-align:left; }

.ok{ color:var(--verde); text-align:center; }
.err{ color:var(--rojo); text-align:center; }
.warn{ color:var(--amarillo); text-align:center; } /* ✅ NUEVO */
</style>
</head>

<body>

<div class="topbar">
  <div class="logo-box">
    <img src="https://revstudio.design/wp-content/uploads/2023/10/RevStudio-logo.png" alt="RevStudio">
  </div>
  <button id="btnVolver" class="btn-back" onclick="volver()">⬅ Volver</button>
</div>

<div class="wrap">
  <h2 id="titulo">MULTISCAN FACTURA</h2>

  <div class="meta">
    Cliente: <b id="cliente">—</b> · Orden ID: <b id="orden">—</b>
  </div>

  <div class="stats">
    <div class="card">
      Sesión<br><b id="cntSesion">0</b>
    </div>
    <div class="card">
      <span id="lblTotal">Total factura</span><br><b id="cntTotal">0</b>
    </div>
  </div>

  <input
    id="scanInput"
    type="text"
    autocomplete="off"
    autocorrect="off"
    spellcheck="false"
    placeholder="Escanee código…"
  >

  <p id="status"></p>

  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Cant.</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script>
/* ================= CONFIG ================= */
const APPSHEET_APP_ID = "134208bd-92de-4550-b09a-657cb1cbdf2e";
const APPSHEET_KEY   = "V2-1yk0i-hFZLD-4XZ3z-n5RCB-Cl6iS-MocBD-nFdJb-Cta9q"; // ✅ EXACTA (la tuya)
const TABLE_FACTURAS  = "SALIDAS FACTURAS";
const TABLE_PRESTAMOS = "SALIDAS PRESTAMOS";
/* ========================================= */

/* ---------- PARAMS ---------- */
const params = new URLSearchParams(location.search);
const ORDEN_ID = Number(params.get("orden_id"));
const CLIENTE  = params.get("cliente") || "—";
const TOTAL_INICIAL = Number(params.get("total") || 0);

// tipo= factura | prestamo (también acepta modo=...)
function stripAccents(s){
  try{ return (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
  catch(_){ return (s || ""); }
}
const rawTipo = (params.get("tipo") || params.get("modo") || "factura").toLowerCase();
const tipo = stripAccents(rawTipo).replace(/\s+/g,"");
const ES_PRESTAMO = (tipo === "prestamo" || tipo === "prestamos" || tipo.startsWith("prest"));

const TABLE_LINES  = ES_PRESTAMO ? TABLE_PRESTAMOS : TABLE_FACTURAS;
const BACK_VIEW    = ES_PRESTAMO ? "PRESTAMOS_Detail" : "FACTURAS_Detail";
const TITULO       = ES_PRESTAMO ? "MULTISCAN PRESTAMO" : "MULTISCAN FACTURA";
const TOTAL_LABEL  = ES_PRESTAMO ? "Total prestamos" : "Total factura";
const BACK_TEXT    = ES_PRESTAMO ? "⬅ Volver a prestamo" : "⬅ Volver a factura";

document.getElementById("orden").textContent   = ORDEN_ID;
document.getElementById("cliente").textContent = CLIENTE;

// UI dinámica
document.title = TITULO;
const tituloEl = document.getElementById("titulo");
if(tituloEl) tituloEl.textContent = TITULO;
const lblTotalEl = document.getElementById("lblTotal");
if(lblTotalEl) lblTotalEl.textContent = TOTAL_LABEL;
const btnVolverEl = document.getElementById("btnVolver");
if(btnVolverEl) btnVolverEl.textContent = BACK_TEXT;

/* ---------- ELEMENTS ---------- */
const input  = document.getElementById("scanInput");
const status = document.getElementById("status");
const lista  = document.getElementById("lista");
const cntS   = document.getElementById("cntSesion");
const cntT   = document.getElementById("cntTotal");

/* ---------- CONTADORES ---------- */
let sesion = 0;
let totalSalida = TOTAL_INICIAL;
cntT.textContent = totalSalida;

/* ---------- FOCO AUTOMÁTICO ---------- */
window.addEventListener("load", () => {
  setTimeout(() => input.focus(), 300);
});

/* ---------- SESIÓN (separada por tipo + orden, para que NO choque) ---------- */
const SESSION_KEY = "multiscan_cnt_" + (ES_PRESTAMO ? "prestamo_" : "factura_") + ORDEN_ID;
sesion = Number(sessionStorage.getItem(SESSION_KEY) || 0);
cntS.textContent = sesion;

/* ---------- API ---------- */
async function api(url, body){
  const r = await fetch(url,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "ApplicationAccessKey":APPSHEET_KEY
    },
    body: JSON.stringify(body)
  });

  // ✅ leemos el texto para clasificar el error (código inválido vs error real)
  const txt = await r.text();

  if(!r.ok) throw (txt || ("HTTP " + r.status));

  try { return JSON.parse(txt); } catch { return txt; }
}

/* ---------- TONOS / VIBRACIÓN ---------- */
function tone(freq, ms){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  o.frequency.value = freq;
  o.connect(ctx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); ctx.close?.(); }, ms);
}

// OK (igual comportamiento: beep)
function beep(){ tone(800, 100); }

// ✅ NUEVOS tonos
function beepWarn(){ tone(420, 140); } // código inválido / no existe
function beepErr(){  tone(220, 220); } // error duro

function vibrar(pattern){
  try{
    if(navigator.vibrate) navigator.vibrate(pattern);
  }catch(_){}
}

// ✅ detector basado en el error real que tú mostraste:
// "Invalid value for column CODIGO_ESCANEO: 12345"
function esErrorCodigoInvalido(errText){
  const t = String(errText || "").toLowerCase();
  return (
    (t.includes("invalid value for column") && t.includes("codigo_escaneo")) ||
    t.includes("invalid value for column") ||
    t.includes("invalid value") ||
    t.includes("can't add or update a row because of an invalid value")
  );
}

/* ---------- ESCANEO ---------- */
input.addEventListener("keydown", async (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();

    const codigo = input.value.trim().replace(/\s+/g,"");
    input.value = "";
    if(!codigo) return;

    status.textContent = "Enviando…";
    status.className = "";

    try{
      const url = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${encodeURIComponent(TABLE_LINES)}/Action`;
      const body = {
        Action:"ADD",
        Properties:{ Locale:"es-ES" },
        Rows:[{
          ID: crypto.randomUUID(),
          "ORDEN ID": ORDEN_ID,
          "CODIGO_ESCANEO": codigo,
          "CANTIDAD": 1
        }]
      };
      await api(url, body);

      beep();

      sesion++;
      sessionStorage.setItem(SESSION_KEY, sesion);
      cntS.textContent = sesion;

      totalSalida++;
      cntT.textContent = totalSalida;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${codigo}</td><td>1</td>`;
      lista.prepend(tr);

      status.textContent = "OK";
      status.className = "ok";

      setTimeout(() => input.focus(), 50);

    }catch(err){
      console.error(err);

      if(esErrorCodigoInvalido(err)){
        beepWarn();
        vibrar([80, 60, 80]); // ✅ vibración corta-doble
        status.textContent = `CÓDIGO ${codigo} NO EXISTE / INCORRECTO`;
        status.className = "warn";
      }else{
        beepErr();
        status.textContent = "ERROR – no se pudo registrar";
        status.className = "err";
      }

      setTimeout(() => input.focus(), 50);
    }
  }
});

function volver(){
  const urlApp = `appsheet://www.appsheet.com/start/${APPSHEET_APP_ID}#view=${BACK_VIEW}&row=${encodeURIComponent(ORDEN_ID)}`;
  const urlWeb = `https://www.appsheet.com/start/${APPSHEET_APP_ID}#view=${BACK_VIEW}&row=${encodeURIComponent(ORDEN_ID)}`;

  // Intenta abrir AppSheet
  window.location.href = urlApp;

  // Fallback por si Android no intercepta el scheme
  setTimeout(() => {
    window.location.href = urlWeb;
  }, 600);
}

</script>

</body>
</html>
